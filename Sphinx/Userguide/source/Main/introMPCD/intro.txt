.. _MPCD:

In many situtations in soft matter physics, the fluid medium in which mesoscale particles---such as polymers, colloids or cells---are suspended is crucial but not the principle interest of study. 
In such cases, coarse-grained algorithms that simulate one or more aspect of the surrounding fluid are needed. 
For example, if the most significant effect of the fluid is to induce thermal fluctuations then a Langevin or Brownian dynamics simulation might be most suitable [slater2009]_. 
On the other hand, if the embedded particles are large enough that thermal fluctuations are negligible but hydrodynamic interactions between them are significant then an immersed boundary solver [mittel2005]_ or lattice-Boltzmann simulation [aidun2010]_ might be more appropriate. 

* If both **fluctuations and hydrodynamic interactions are crucial** then *MPCD* may be an appropriate simulation technique. 

Multi-Particle Collision Dynamics (MPCD) is a technique for simulating fluctuating hydrodynamics that reproduces the Navier-Stokes equation on sufficiently long length and time acales~\cite{**CCC**}. 
It is well suited for situations for which viscosity dominates over inertia, and diffusion is of similar significance to advective flow (see :ref:`Dimensionless Numbers <chapterUnits>`). 
It is straightforward to include mobile particles, such as colloids, within the MPCD fluid, even if these have many internal degress of freedom, such as polymers. 
This makes MPCD an excellent option for simulating complex suspensions. 
Furthermore, because MPCD is a particle-based method, non-trivial boundaries can be included more easily than methods that require complicated meshes. 

As in any computational approach, these benefits are counterbalanced by complications, including 

#. fluid properties (such as viscosity or other transport coefficients) are only controlled indirectly~\cite{**??**}, 
#. multiple runs must be averaged to find statisticly meaningful results~\cite{**pooley05**}, and
#. compressibility~\cite{**stark?**}. 

.. _particleBased:
Particle-based coarse-graining
==============================

In MPCD, the continuous fluid medium is discretised into point-like, coarse-grained fluid particles. 
Equivalently one may imagine that many fluid atoms or molecules are grouped together and simulated as point-like particles. 
This coarse-graning eschews molecular-scale details of the molecules that make up the fluid. 
Respecting conservation of these quantities is what allows the hydrodynamic equations of motion to be obeyed on sufficiently long length and time scales~\cite{**pooley05**}. 

Thus, MPCD **does not** give correct dynamics on microscopic time or length scales. 
Streaming and collision events conserve the momentum and energy in each collision volume at all times and so MPCD reproduces an accurate representation of the hydrodynamics of the velocity field at large distances. 
The coarse-grained mesoscopic MPCD fluid provides both a thermal bath and propagates hydrodynamic interactions without having to either solve the entire Navier-Stokes equation (**MISSING**\eq{eq:NS}) for a potentially complex microfluidic system or to simulate the full molecular interactions of all fluid molecules. 
Therefore, it can be computationally less expensive than numerical, continuum solvers or full *Molecular Dynamics* (MD) simulations. 

Two-step algorithm
==================

In essence, the MPCD algorithm consists of only two steps:

#. The first step is the :ref:`streaming step <streaming>`.
#. The second is the :ref:`collision step <collision>`.

**MAKE FIGURE**

.. _streaming:
Streaming step
--------------

Each fluid particle (labelled :math:`i`) of mass :math:`m_i` moves ballistically, and its position :math:`\vec{x}_i\left(t\right)` is updated in discrete time intervals :math:`\delta t`. 
In the **streaming step** the particles move according to 

.. math::
    :name: eq:stream

    \vec{x}_i\left(t+\delta t\right) = \vec{x}_i\left(t\right) + \vec{v}_i\left(t\right) \delta t .
If the MPCD algorithm consisted only of streaming steps then the carrier fluid would be an ideal gas; however, the :ref:`collision step <collision>` introduces coarse-grained interactions between particles. 
Particle properties are continuous---not discretised (see :ref:`Particle Properties <chapter4>`). 

.. _collision:
Collision step
--------------

The second step is the **collision step** in which momentum is transferred between fluid particles. 
To exchange momentum the simulation domain is partitioned into :math:`d`-dimensional square cells of size :math:`a`. 
After streaming, all particles are binned into cells (labelled :math:`c`) and all the particles in a given cell are said to *collide* locally exchanging particle properties via a stochastic collision operation. 

The collision step is typically a simple, non-physical scheme constructed to be stochastic but also obey appropraite conservation laws (such as conservation of momentum, angular momentum and energy) within each cell. 
Multi-particle collisions within cells are represented by the collision operator :math:`\vec{\Xi}` such that the velocity of each particle in a given cell evolves as

.. math::
    :name: eq:collision
    
    \vec{v}_i\left(t + \delta t\right) = \vec{v}^{c}\left(t\right) + \vec{\Xi} \left( \; \vec{v}_i\left(t\right), \vec{v}^{c}\left(t\right) \; \right) .
The number of fluid particles in the :math:`c^\text{th}` cell at time :math:`t` is :math:`{N_c}\left(t\right)`. 
The number of particles in each cell may vary from one cell to another but the total number :math:`N_\text{tot}` is conserved and the average number density is :math:`n=\left\langle N_c \right\rangle/a^d` where :math:`d` is the dimensionality of the simulation and :math:`\left\langle \cdot \right\rangle` is the average over all cells. 
Each cell possesses a centre of mass velocity :math:`\vec{v}^{c} = \left\langle v_i \right\rangle_c = \left(\sum^{N_c}_{i=1} m_i \vec{v}_i\right)/\left(\sum^{N_c}_{i=1} m_i\right)`, where :math:`\left\langle \cdot \right\rangle_c` represents the average within cell :math:`c`. 
The cell velocity :math:`\vec{v}^{c}` corresponds to the local macroscopic velocity :math:`\vec{v}\left(\vec{x}_c,t\right)` at the location of cell :math:`c` and time :math:`t`. 
Thus, these cell-based values are interpretted as discretized field values (see :ref:`Cell Properties <chapterCell>`)

The MPCD collision step replaces molecular-scale dynamics with a local, non-physical, stochastic momentum transfer operation. 
A number of collision operators are available (see :ref:Collision operators <chapter5>). 

.. _angMom:
Conservation of angular momentum
================================

However, the SRD algorithm does not generally conserve angular momentum since the positions of the fluid particles within the cell during a collision operation are not taken into account~\cite{ryder05}. 
While some of the other variations on the MPCD algorithm do (see \sctn{sctn:anderson_ang}), in the microfluidic situations considered here (and most others~\cite{gotze07,gotze10,gotze11,babu12}) angular momentum does not play an essential role and so this fact is inconsequential. 

The Anderson-MPCD algorithm discussed so far conserves mass\index{mass!conservation}, energy\index{conservation!energy} and translational momentum\index{conservation!momentum} but, just like the SRD collision operations, it does not conserve angular momentum.
However, it can be extended to do so. 

In conserving the angular momentum of the cell, the position of each fluid particle relative to the centre of mass of the cell :math:`\vec{x}^\prime_i = \vec{x}_i - \vec{x}^{c}` is important. 
The Anderson-MPCD algorithm presented in \sctn{sctn:anderson} creates a small change in angular momentum every collision step. 
Let this amount be denoted :math:`\delta \vec{L}`. 
This angular momentum can be exactly cancelled out by giving the entire cell an appropriate angular velocity :math:`\vec{\omega}`. 
If the set of particles in the cell have a moment of inertia tensor :math:`\textbf{I}` about the centre of mass (with elements :math:`I_{ij} = \sum_k^{N_c} m_k \left( {x^\prime_k}^2 \delta_{ij} - r_{k,i}^\prime r_{k,j}^\prime\right)`) then the angular velocity needed to cancel the residual angular momentum is :math:`\vec{\omega} = \textbf{I}^{-1} \cdot \delta \vec{L}`. 

A term representing the change in linear velocity resulting from the imposed angular velocity about the centre of mass can be added to \eq{eq:at}:
% \begin{align}
%  \vec{\Xi} &= \vec{v}_i^\mathrm{ran} - \frac{1}{N_c} \sum_{j}^{N_c} \vec{v}_j^\mathrm{ran} + \vec{\omega} ts \vec{x}^\prime_i\nn\\
%         &= \vec{v}_i^\mathrm{ran} - \frac{1}{N_c} \sum_{j}^{N_c} \vec{v}_j^\mathrm{ran} + \left[\textbf{I}^{-1}\cdot\delta\vec{L}\right] ts \vec{x}^\prime_i\nn\\
%         &= \vec{v}_i^\mathrm{ran} - \frac{1}{N_c} \sum_{j}^{N_c} \vec{v}_j^\mathrm{ran} + 
%    \left[ m \textbf{I}^{-1} \cdot \left( \sum_{j}^{N_c} \left\lbrace \vec{x}^\prime_j ts \left( \vec{v}_j - \vec{v}_j^\mathrm{ran} \right) \right\rbrace   \right) \right]ts \vec{x}^\prime_i.
%  \label{at_ang}
% \end{align}

.. math::
    :name: eq:angMom
    
    \vec{\Xi} = \vec{v}^\text{ran}_i - \frac{\sum_{j}^{N_c} m_j \vec{v}^\text{ran}_{j}}{\sum_{j}^{N_c} m_j} + \left[ \textbf{I}^{-1} \cdot \left( \sum_{j}^{N_c} m_j \left\lbrace \vec{x}^\prime_j ts \left( \vec{v}_j - \vec{v}^\text{ran}_j \right) \right\rbrace   \right) \right]ts \vec{x}^\prime_i.
For situations in which angular momentum conservation within the solvent plays an important role, \eq{eq:at_ang} should be preferred over \eq{eq:at}. 

.. rubric:: Reference

.. [slater2009] Slater, *et al* (2009), `Modeling the Separation of Macromolecules <https://doi.org/10.1002/elps.200800673>`_. *Electrophoresis*, vol 30. 
.. [aidun2010] Aidun & Clausen (2010), `Lattice-Boltzmann Method for Complex Flows <https://doi.org/10.1146/annurev-fluid-121108-145519>`_. *Annual Review of Fluid Mechanics*, vol 42.
.. [mittel2005] Mittal & Iaccarino (2005), `Immersed Boundary Methods <https://www.annualreviews.org/doi/full/10.1146/annurev.fluid.37.061903.175743>`_. *Annual Review of Fluid Mechanics*, vol 37.
